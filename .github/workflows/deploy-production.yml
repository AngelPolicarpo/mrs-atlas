name: ðŸš€ Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permite deploy manual

env:
  AZURE_RESOURCE_GROUP: rg-atlas-prod
  ENVIRONMENT_NAME: atlas-env

jobs:
  # =====================
  # Detectar mudanÃ§as
  # =====================
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # =====================
  # Deploy Backend
  # =====================
  deploy-backend:
    name: ðŸ Deploy Backend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login ACR
        run: |
          az acr login --name ${{ secrets.AZURE_ACR_NAME }}

      - name: ðŸ³ Build and Push
        run: |
          ACR_SERVER=${{ secrets.AZURE_ACR_NAME }}.azurecr.io
          IMAGE_SHA=${ACR_SERVER}/atlas-backend:${{ github.sha }}
          IMAGE_LATEST=${ACR_SERVER}/atlas-backend:latest
          
          docker build -t $IMAGE_SHA -t $IMAGE_LATEST -f backend/Dockerfile.prod ./backend
          docker push $IMAGE_SHA
          docker push $IMAGE_LATEST
          
          echo "IMAGE=$IMAGE_SHA" >> $GITHUB_ENV

      - name: ðŸš€ Deploy to Container Apps
        run: |
          az containerapp update \
            --name atlas-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.IMAGE }}

      - name: ðŸ§ª Run Migrations
        run: |
          # Aguardar container estar pronto
          sleep 30
          az containerapp exec \
            --name atlas-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --command "python manage.py migrate --noinput" || true

      - name: ðŸ©º Health Check
        run: |
          BACKEND_URL=$(az containerapp show \
            --name atlas-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          echo "Checking health at https://$BACKEND_URL/api/health/"
          
          for i in {1..12}; do
            if curl -sf "https://$BACKEND_URL/api/health/" > /dev/null 2>&1; then
              echo "âœ… Backend is healthy!"
              exit 0
            fi
            echo "Waiting for backend... attempt $i/12"
            sleep 10
          done
          echo "âš ï¸ Health check timed out, but deployment may still be successful"

  # =====================
  # Deploy Frontend
  # =====================
  deploy-frontend:
    name: âš›ï¸ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [changes, deploy-backend]
    if: always() && (needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch')

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login ACR
        run: |
          az acr login --name ${{ secrets.AZURE_ACR_NAME }}

      - name: ðŸ“ Get Backend URL
        run: |
          BACKEND_URL=$(az containerapp show \
            --name atlas-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend URL: https://$BACKEND_URL"

      - name: ðŸ³ Build and Push
        run: |
          ACR_SERVER=${{ secrets.AZURE_ACR_NAME }}.azurecr.io
          IMAGE_SHA=${ACR_SERVER}/atlas-frontend:${{ github.sha }}
          IMAGE_LATEST=${ACR_SERVER}/atlas-frontend:latest
          
          docker build \
            -t $IMAGE_SHA \
            -t $IMAGE_LATEST \
            -f frontend/Dockerfile.prod \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            ./frontend
          
          docker push $IMAGE_SHA
          docker push $IMAGE_LATEST
          
          echo "IMAGE=$IMAGE_SHA" >> $GITHUB_ENV

      - name: ðŸš€ Deploy to Container Apps
        run: |
          az containerapp update \
            --name atlas-frontend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.IMAGE }}

  # =====================
  # Resumo do Deploy
  # =====================
  summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: ðŸ” Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: ðŸ“‹ Create Summary
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | ${{ github.workflow }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status dos jobs
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result == 'success' && 'âœ… Success' || needs.deploy-backend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result == 'success' && 'âœ… Success' || needs.deploy-frontend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # URLs
          FRONTEND_URL=$(az containerapp show \
            --name atlas-frontend \
            --resource-group rg-atlas-prod \
            --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || echo "N/A")
          
          BACKEND_URL=$(az containerapp show \
            --name atlas-backend \
            --resource-group rg-atlas-prod \
            --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || echo "N/A")
          
          echo "### ðŸŒ Application URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | https://$FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | https://$BACKEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | https://$BACKEND_URL/api/health/ |" >> $GITHUB_STEP_SUMMARY
