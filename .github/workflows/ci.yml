name: CI - Testes

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

jobs:
  # =====================
  # Testes do Backend
  # =====================
  test-backend:
    name: ğŸ Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ğŸ” Check migrations
        env:
          DATABASE_URL: postgres://test_user:test_pass@localhost:5432/test_db
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: 'False'
        run: |
          cd backend
          python manage.py migrate
          python manage.py check

  # =====================
  # Testes do Frontend
  # =====================
  test-frontend:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ” Lint
        run: |
          cd frontend
          npm run lint || true

      - name: ğŸ—ï¸ Build test
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://api.example.com

  # =====================
  # Build Docker (validaÃ§Ã£o)
  # =====================
  build-docker:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ—ï¸ Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: false
          build-args: |
            VITE_API_URL=https://api.example.com
          cache-from: type=gha
          cache-to: type=gha,mode=max
