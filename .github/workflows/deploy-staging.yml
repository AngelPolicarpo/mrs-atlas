name: ðŸ§ª Deploy Staging

on:
  push:
    branches: [dev]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-atlas-staging
  ENVIRONMENT_NAME: atlas-env-staging

jobs:
  # =====================
  # Detectar mudanÃ§as
  # =====================
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # =====================
  # Deploy Backend Staging
  # =====================
  deploy-backend:
    name: ðŸ Deploy Backend (Staging)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login ACR
        run: |
          az acr login --name ${{ secrets.AZURE_ACR_NAME }}

      - name: ðŸ³ Build and Push
        run: |
          ACR_SERVER=${{ secrets.AZURE_ACR_NAME }}.azurecr.io
          IMAGE=${ACR_SERVER}/atlas-backend:staging-${{ github.sha }}
          
          docker build -t $IMAGE -f backend/Dockerfile.prod ./backend
          docker push $IMAGE
          
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: ðŸš€ Deploy to Container Apps
        run: |
          az containerapp update \
            --name atlas-backend-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.IMAGE }}

      - name: ðŸ§ª Run Migrations
        run: |
          sleep 20
          az containerapp exec \
            --name atlas-backend-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --command "python manage.py migrate --noinput" || true

  # =====================
  # Deploy Frontend Staging
  # =====================
  deploy-frontend:
    name: âš›ï¸ Deploy Frontend (Staging)
    runs-on: ubuntu-latest
    needs: [changes, deploy-backend]
    if: always() && (needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch')

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login ACR
        run: |
          az acr login --name ${{ secrets.AZURE_ACR_NAME }}

      - name: ðŸ“ Get Backend URL
        run: |
          BACKEND_URL=$(az containerapp show \
            --name atlas-backend-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "BACKEND_URL=https://$BACKEND_URL" >> $GITHUB_ENV

      - name: ðŸ³ Build and Push
        run: |
          ACR_SERVER=${{ secrets.AZURE_ACR_NAME }}.azurecr.io
          IMAGE=${ACR_SERVER}/atlas-frontend:staging-${{ github.sha }}
          
          docker build \
            -t $IMAGE \
            -f frontend/Dockerfile.prod \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            ./frontend
          
          docker push $IMAGE
          
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: ðŸš€ Deploy to Container Apps
        run: |
          az containerapp update \
            --name atlas-frontend-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.IMAGE }}

  # =====================
  # Resumo
  # =====================
  summary:
    name: ðŸ“‹ Staging Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: ðŸ“‹ Create Summary
        run: |
          echo "## ðŸ§ª Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result == 'success' && 'âœ…' || needs.deploy-backend.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result == 'success' && 'âœ…' || needs.deploy-frontend.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Staging URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://atlas-frontend-staging.brazilsouth.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://atlas-backend-staging.brazilsouth.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
